---
layout: post
title:  "WebSocket"
date:   2019-03-18 09:37:21 +0800
tags: WebSocket
color: rgb(210,255,102)
cover: '../assets/lifetree.jpg'

---


##  WebSocket
### websocket定义：是h5提供的在单个tcp链接上进行的全双工通讯的协议（WebSocket 协议本质上是一个基于 TCP 的协议）。

允许服务端主动向客户端推送数据。更好的节省服务器资源和宽带，实时信息传递。

以往若想服务器向客户端推送数据，需要ajax轮询，前端定时向服务器发送http请求，然后由服务器给客户端最新数据。

但是由于http请求头可能过长，而真正有用的数据可能是很小的一部分，那么不断发送请求向服务器，可能会浪费很多的宽带资源。

<hr>

浏览器通过js向服务器发送请求，建立 WebSocket 连接后，客户端与服务器就可以通过tcp建立连接交换数据。

客户端通过send方法想服务器发送参数，通过onmessage方法接收服务器数据。

建立websocket对象的方法

```
var Socket = new WebSocket(url, [protocol] );
```

<font color="#dd00ee"> WebSocet的事件：</font>，如图所示：

![image][event]


<font color="#dd00ee">websocket方法：</font>

Socket.send()  使用连接发送数据

Socket.close()  关闭连接


jsp页面示例：
```
    // 初始化一个 WebSocket 对象
    var ws = new WebSocket("ws://localhost:9998/echo");

    // 建立 web socket 连接成功触发事件
    ws.onopen = function () {
      // 使用 send() 方法发送数据
      ws.send("发送数据");
      alert("数据发送中...");
    };

    // 接收服务端数据时触发事件
    ws.onmessage = function (evt) {
      var received_msg = evt.data;
      alert("数据已接收...");
    };

    // 断开 web socket 连接成功触发事件
    ws.onclose = function () {
      alert("连接已关闭...");
    };

```

客户端能判断出服务器的socket连接是否关闭，

服务器不能判断出客户端是否关闭，

必须先断服务端，再断客户端。否则客户端出现TIME_WAIT状态，占用系统资源。

问：服务器怎么判断客户端的websocket连接断开？

做一个心跳包，多任务跑，如果心跳断开了 就失联了。。。


注意：客户端不能跳转到其他页面，若跳转页面，websocket就断开了，服务器发送的信息客户端就收不到了

[event]:data:image/png;base64,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